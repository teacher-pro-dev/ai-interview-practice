<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ê¸°ë°˜ ëª¨ì˜ë©´ì ‘ í”„ë¡œê·¸ë¨</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap");
    :root {
      --bg: #f0f4f8;
      --panel: #ffffff;
      --panel-2: #f9fafb;
      --text: #333;
      --muted: #888;
      --primary: #4a90e2;
      --danger: #ff7070;
      --border: #eaecef;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); font-family: 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; color: var(--text); }
    .page { height: 100%; display: flex; align-items: center; justify-content: center; }
    .container { width: 96%; max-width: 1400px; height: 94vh; display: grid; grid-template-columns: 6fr 4fr; gap: 18px; }
    .video-section { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 26px rgba(0,0,0,.06); padding: 18px; display: flex; flex-direction: column; position: relative; overflow: hidden; }
    .right { background: var(--panel-2); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 26px rgba(0,0,0,.05); padding: 18px; display: flex; flex-direction: column; gap: 16px; overflow: hidden; }
    .title { font-size: 22px; font-weight: 700; color: var(--primary); margin: 0 0 6px; }
    .hint { font-size: 12px; color: var(--muted); margin: 0 0 12px; }
    .video-wrap { position: relative; flex: 1; min-height: 0; border-radius: 12px; overflow: hidden; background: #111; display: grid; place-items: center; }
    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .overlay { position: absolute; inset: 0; pointer-events: none; display: flex; align-items: flex-start; justify-content: space-between; padding: 12px; }
    #timer { font-family: 'Courier New', monospace; background: rgba(255,255,255,.85); padding: 6px 10px; border-radius: 8px; font-weight: 700; }
    #countdown { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; font-size: 80px; color: white; text-shadow: 0 0 20px rgba(0,0,0,.55); background: rgba(0,0,0,.35); font-weight: 800; }
    .controls { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .btn { border: none; background: #eef3f7; padding: 10px 14px; border-radius: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; box-shadow: 0 4px 14px rgba(0,0,0,.05); transition: transform .15s ease, background .2s ease; }
    .btn:hover { transform: translateY(-1px); background: #e9eef3; }
    .btn:disabled { opacity: .55; cursor: not-allowed; transform: none; }
    #recordBtn { background: var(--danger); color: #fff; }
    #recordBtn.recording { background: var(--primary); }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: inset 0 1px 0 rgba(255,255,255,.4); }
    .panel h3 { margin: 0 0 8px; font-size: 15px; display: flex; align-items: center; gap: 6px; }
    #transcriptBox { height: 180px; overflow: auto; padding: 10px; border-radius: 10px; background: #fff; border: 1px dashed #dfe3e7; font-size: 14px; line-height: 1.5; }
    #answerBox { height: 140px; overflow: auto; padding: 10px; border-radius: 10px; background: #fff; border: 1px dashed #dfe3e7; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .input { width: 100%; border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; background: #fff; font-size: 14px; }
    .muted { color: var(--muted); font-size: 12px; }
    .sticky-actions { margin-top: auto; display: flex; gap: 10px; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="container">
      <section class="video-section">
        <h1 class="title">ëª¨ì˜ ë©´ì ‘ í”„ë¡œê·¸ë¨</h1>
        <p class="hint">ì¹´ë©”ë¼Â·ë§ˆì´í¬ ê¶Œí•œ í—ˆìš© í›„, <b>ë…¹í™”</b> ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”. ì•ˆë“œë¡œì´ë“œ ê¸°ê¸°ëŠ” ìë™ìœ¼ë¡œ ëŒ€ì²´ ì „ì‚¬ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>
        <div class="video-wrap">
          <video id="webcam" autoplay playsinline muted></video>
          <div class="overlay">
            <div id="timer">00:00</div>
          </div>
          <div id="countdown">3</div>
        </div>
        <div class="controls">
          <button id="recordBtn" class="btn">â— ë…¹í™”</button>
          <button id="pauseBtn" class="btn" disabled>â¸ï¸ ì¼ì‹œì •ì§€</button>
          <button id="saveBtn" class="btn" disabled>ğŸ’¾ ì˜ìƒ ì €ì¥</button>
          <button id="permBtn" class="btn">ğŸ”’ ê¶Œí•œ í™•ì¸</button>
        </div>
      </section>

      <aside class="right">
        <div class="panel">
          <h3>ì§ˆë¬¸ ì…ë ¥</h3>
          <input id="questionInput" class="input" placeholder="ë©´ì ‘ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)" />
          <p class="muted small">ì§ˆë¬¸ì€ ì „ì‚¬/ìš”ì•½ê³¼ í•¨ê»˜ ì €ì¥ë˜ë©°, ì‹¤ì‹œê°„ ì „ì‚¬ì—ëŠ” ì˜í–¥ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="panel">
          <h3>ì‹¤ì‹œê°„ ë‚´ìš© ì •ë¦¬</h3>
          <div id="transcriptBox">ìŒì„± ì¸ì‹ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤â€¦</div>
          <p id="sttModeMsg" class="muted small" style="margin-top:6px;"></p>
        </div>
        <div class="panel">
          <h3>ëª¨ë²” ë‹µì•ˆ / ìš”ì•½</h3>
          <div id="answerBox">ë…¹í™” ì¢…ë£Œ í›„ ì„œë²„ ìš”ì•½ì„ í˜¸ì¶œí•˜ë„ë¡ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜µì…˜)</div>
          <div class="sticky-actions">
            <button id="copyBtn" class="btn">ğŸ“‹ ë‹µë³€ ë³µì‚¬</button>
            <button id="summBtn" class="btn">ğŸª„ ì„œë²„ ìš”ì•½ ìš”ì²­</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ---------- ì „ì—­ ìƒíƒœ ----------
    const webcam = document.getElementById('webcam');
    const recordBtn = document.getElementById('recordBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const saveBtn = document.getElementById('saveBtn');
    const permBtn = document.getElementById('permBtn');
    const countdownEl = document.getElementById('countdown');
    const timerEl = document.getElementById('timer');
    const transcriptBox = document.getElementById('transcriptBox');
    const sttModeMsg = document.getElementById('sttModeMsg');
    const answerBox = document.getElementById('answerBox');
    const copyBtn = document.getElementById('copyBtn');
    const summBtn = document.getElementById('summBtn');
    const questionInput = document.getElementById('questionInput');

    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let seconds = 0, timerId = null;

    let fullTranscript = '';

    // STT ê²½ë¡œ ë¶„ê¸°
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let useFallbackSTT = false; // Android/Samsung/ë¯¸ì§€ì› ë¸Œë¼ìš°ì € í´ë°±

    let isRecording = false;
    let isPaused = false;

    // í´ë°±ìš© ì˜¤ë””ì˜¤ ì „ì†¡ ìƒíƒœ
    let fallbackRecorder = null;
    let fallbackIntervalId = null;

    // ---------- ê¶Œí•œ ë° ì›¹ìº  ----------
    async function setupWebcam() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        webcam.srcObject = stream;
      } catch (err) {
        alert('ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”.');
        console.error(err);
      }
    }

    async function checkPermissions() {
      try {
        const statuses = await navigator.permissions?.query({ name: 'microphone' }).catch(()=>null);
        const statuses2 = await navigator.permissions?.query({ name: 'camera' }).catch(()=>null);
        alert(`ë§ˆì´í¬: ${statuses?.state || 'í™•ì¸ ë¶ˆê°€'} / ì¹´ë©”ë¼: ${statuses2?.state || 'í™•ì¸ ë¶ˆê°€'}`);
      } catch(e) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ê¶Œí•œ ìƒíƒœ ì¡°íšŒë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    }

    // ---------- íƒ€ì´ë¨¸ ----------
    function startTimer(){
      stopTimer();
      timerId = setInterval(()=>{
        seconds++;
        const mm = String(Math.floor(seconds/60)).padStart(2, '0');
        const ss = String(seconds%60).padStart(2, '0');
        timerEl.textContent = `${mm}:${ss}`;
      }, 1000);
    }
    function stopTimer(){ if (timerId) clearInterval(timerId); timerId = null; }
    function resetTimer(){ seconds = 0; timerEl.textContent = '00:00'; }

    // ---------- STT ë¶„ê¸° íŒë‹¨ ----------
    (function decideSTTPath(){
      const ua = navigator.userAgent || '';
      const isAndroid = /Android/i.test(ua);
      const isSamsungInternet = /SamsungBrowser/i.test(ua);
      useFallbackSTT = !SpeechRecognition || isAndroid || isSamsungInternet;
      sttModeMsg.textContent = useFallbackSTT
        ? 'ì´ ê¸°ê¸°ëŠ” ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„±ì¸ì‹ì´ ë¯¸ì§€ì›ì´ê±°ë‚˜ ì œí•œë˜ì–´ ëŒ€ì²´ ì „ì‚¬ ëª¨ë“œ(3ì´ˆ ì²­í¬ ì—…ë¡œë“œ)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
        : 'ì´ ê¸°ê¸°ëŠ” ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„±ì¸ì‹(Web Speech API)ìœ¼ë¡œ ì‹¤ì‹œê°„ ì „ì‚¬ê°€ ë™ì‘í•©ë‹ˆë‹¤.';
    })();

    // ---------- Web Speech API ê²½ë¡œ ----------
    function initRecognition(){
      if (!SpeechRecognition) return;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'ko-KR';

      recognition.onresult = (event)=>{
        let interim = '', finalTxt = '';
        for (let i=0; i<event.results.length; i++) {
          const r = event.results[i];
          const t = r[0].transcript;
          if (r.isFinal) finalTxt += t; else interim += t;
        }
        if (finalTxt) fullTranscript = (fullTranscript + ' ' + finalTxt).trim();
        transcriptBox.innerHTML = (fullTranscript || '') + (interim ? ` <i style="color:#999;">${interim}</i>` : '');
      };
      recognition.onerror = (e)=>{
        console.warn('SpeechRecognition error:', e.error);
      };
    }

    // ---------- í´ë°±: 3ì´ˆë§ˆë‹¤ ì˜¤ë””ì˜¤ ì²­í¬ ì—…ë¡œë“œ ----------
    async function startFallbackTranscription(){
      // ì˜¤ë””ì˜¤ë§Œ ë³„ë„ë¡œ ì¶”ì¶œ
      const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      fallbackRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
      let pending = [];
      fallbackRecorder.ondataavailable = (e)=>{ if (e.data && e.data.size>0) pending.push(e.data); };
      fallbackRecorder.start(1000);
      fallbackIntervalId = setInterval(async ()=>{
        if (!isRecording) return;
        if (!pending.length) return;
        const blob = new Blob(pending, { type: 'audio/webm' });
        pending = [];
        try {
          const form = new FormData();
          form.append('file', blob, `chunk-${Date.now()}.webm`);
          form.append('lang', 'ko');
          const q = (questionInput.value || '').trim();
          if (q) form.append('question', q);
          const res = await fetch('/api/transcribe', { method: 'POST', body: form });
          if (!res.ok) throw new Error('STT ì„œë²„ ì˜¤ë¥˜: ' + res.status);
          const data = await res.json();
          const text = (data.text || '').trim();
          if (text) {
            fullTranscript = (fullTranscript + ' ' + text).trim();
            transcriptBox.innerHTML = fullTranscript + ' <i class="small muted">(ì²˜ë¦¬ì¤‘)</i>';
          }
        } catch(err){ console.error(err); }
      }, 3000);
    }
    function stopFallbackTranscription(){
      try {
        if (fallbackIntervalId) clearInterval(fallbackIntervalId);
        fallbackIntervalId = null;
        if (fallbackRecorder && fallbackRecorder.state !== 'inactive') fallbackRecorder.stop();
      } catch(e){ console.warn(e); }
      finally { fallbackRecorder = null; }
    }

    // ---------- ë…¹í™” í•¸ë“¤ëŸ¬ ----------
    recordBtn.addEventListener('click', async ()=>{
      // í˜„ì¬ ë…¹í™” ì¤‘ì´ë©´ ì •ì§€
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        isRecording = false;
        mediaRecorder.stop();
        if (!useFallbackSTT) { try { recognition && recognition.stop(); } catch(_){} }
        else { stopFallbackTranscription(); }
        recordBtn.classList.remove('recording');
        recordBtn.textContent = 'â— ë…¹í™”';
        saveBtn.disabled = false;
        pauseBtn.disabled = true;
        isPaused = false;
        stopTimer();
        return;
      }

      // ì‹œì‘ ì¹´ìš´íŠ¸ë‹¤ìš´
      let count = 3;
      countdownEl.textContent = count;
      countdownEl.style.display = 'flex';
      recordBtn.disabled = true;

      const tick = setInterval(async ()=>{
        count--;
        if (count>0) { countdownEl.textContent = count; return; }
        clearInterval(tick);
        countdownEl.style.display = 'none';
        recordBtn.disabled = false;

        // ì‹¤ì œ ë…¹í™” ì‹œì‘
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (e)=>{ if (e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.start();

        // STT ì‹œì‘
        isRecording = true;
        fullTranscript = '';
        transcriptBox.textContent = 'ìŒì„± ì¸ì‹ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤â€¦';

        if (!useFallbackSTT) {
          if (!recognition) initRecognition();
          try { recognition && recognition.start(); } catch(_){}
        } else {
          await startFallbackTranscription();
        }

        recordBtn.classList.add('recording');
        recordBtn.textContent = 'â–  ì¢…ë£Œ';
        saveBtn.disabled = true;
        pauseBtn.disabled = false;
        resetTimer();
        startTimer();
      }, 1000);
    });

    // ì¼ì‹œì •ì§€/ì¬ê°œ
    pauseBtn.addEventListener('click', ()=>{
      if (!mediaRecorder) return;
      if (isPaused) {
        mediaRecorder.resume();
        if (!useFallbackSTT) { try { recognition && recognition.start(); } catch(_){} }
        startTimer();
        pauseBtn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
      } else {
        mediaRecorder.pause();
        if (!useFallbackSTT) { try { recognition && recognition.stop(); } catch(_){} }
        stopTimer();
        pauseBtn.textContent = 'â–¶ï¸ ì¬ê°œ';
      }
      isPaused = !isPaused;
    });

    // ì˜ìƒ ì €ì¥
    saveBtn.addEventListener('click', ()=>{
      if (!recordedChunks.length) return alert('ì €ì¥í•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const ts = new Date().toISOString().replace(/[:.]/g, '-');
      a.download = `interview-${ts}.webm`;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    });

    // ê¶Œí•œ í™•ì¸
    permBtn.addEventListener('click', checkPermissions);

    // ìš”ì•½(ì˜µì…˜ ì„œë²„ í˜¸ì¶œ)
    summBtn.addEventListener('click', async ()=>{
      const text = fullTranscript.trim();
      if (!text) return alert('ìš”ì•½í•  ì „ì‚¬ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
      try {
        const res = await fetch('/api/summarize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ transcript: text, question: questionInput.value || '' }) });
        if (!res.ok) throw new Error('ìš”ì•½ ì„œë²„ ì˜¤ë¥˜: ' + res.status);
        const data = await res.json();
        answerBox.textContent = (data.summary || 'ìš”ì•½ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
      } catch(err){
        console.error(err);
        alert('ìš”ì•½ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ êµ¬ì„±ì„ í™•ì¸í•˜ì„¸ìš”.');
      }
    });

    // ë³µì‚¬
    copyBtn.addEventListener('click', async ()=>{
      const txt = answerBox.textContent || '';
      if (!txt) return;
      try { await navigator.clipboard.writeText(txt); copyBtn.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ'; setTimeout(()=> copyBtn.textContent='ğŸ“‹ ë‹µë³€ ë³µì‚¬', 1800); }
      catch(err){ alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err); }
    });

    // ì´ˆê¸°í™”
    window.addEventListener('load', setupWebcam);
  </script>
</body>
</html>
