<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 기반 모의 면접 프로그램</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { background-color: #F0F4F8; font-family: 'Noto Sans KR', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { display: flex; width: 95%; max-width: 1400px; height: 95vh; max-height: 800px; background-color: white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.1); overflow: hidden; }
        .video-section { flex: 6; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 30px; box-sizing: border-box; background-color: #fff; border-right: 1px solid #EAECEF; position: relative; }
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10em; font-weight: 700; color: rgba(255,255,255,.8); z-index: 100; display: none; text-shadow: 0 0 20px rgba(0,0,0,.5); }
        .header-info { width: 100%; z-index: 10; }
        #programTitle { font-size: 1.8em; font-weight: 700; color: #4A90E2; margin: 0 0 10px 0; }
        #usageGuide { font-size: 0.9em; color: #888; line-height: 1.6; margin: 0; padding-left: 5px; }
        .video-container { width: 100%; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 0; }
        #webcam { width: 100%; max-height: 100%; border-radius: 16px; background-color: #111; transform: scaleX(-1); object-fit: cover; }
        #timer { font-size: 1.5em; color: #333; font-family: 'Courier New', Courier, monospace; margin-top: 15px; }
        .controls { display: flex; gap: 15px; align-items: center; margin-top: 15px; }
        .control-item { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .control-item span { font-size: .8em; color: #888; }
        .controls button { background-color: #F0F4F8; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 1.5em; color: #4A90E2; display: flex; justify-content: center; align-items: center; transition: all .2s ease-in-out; }
        .controls button:hover { background-color: #EAECEF; transform: translateY(-2px); }
        .controls button:disabled { opacity: .5; cursor: not-allowed; }
        #recordBtn { background-color: #FF7070; color: white; width: 60px; height: 60px; font-size: 1.1em; }
        #recordBtn.recording { background-color: #4A90E2; }
        .info-section { flex: 4; background-color: #F9FAFB; padding: 30px; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .info-section h3 { margin: 0 0 10px 0; color: #333; font-size: 1.1em; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .input-group { background: white; padding: 15px; border-radius: 12px; border: 1px solid #EAECEF; }
        .input-group input, .input-group select { width: 100%; padding: 12px; background-color: #F0F4F8; border: 1px solid #EAECEF; color: #333; border-radius: 8px; font-size: 1em; }
        #customQuestion { margin-top: 10px; }
        .output-group { background: white; padding: 15px; border-radius: 12px; border: 1px solid #EAECEF; flex-grow: 1; display: flex; flex-direction: column; }
        .output-box { overflow-y: auto; flex-grow: 1; line-height: 1.7; font-size: 0.95em; }
        #copyBtn { margin-left: auto; padding: 5px 10px; font-size: 0.8em; background-color: #4A90E2; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .feedback-guide p { margin: 10px 0; font-size: 0.9em; }
        .feedback-guide a { display: block; text-align: center; padding: 15px; border-radius: 8px; text-decoration: none; font-weight: 700; font-size: 1.1em; background-color: #333; color: white; transition: background-color 0.2s; }
        .feedback-guide a:hover { background-color: #555; }
        .search-guide { margin-top: 12px; padding: 10px; background-color: #F0F4F8; border-radius: 6px; font-size: 0.85em; color: #555; line-height: 1.6; }
        @media (max-width: 900px) {
            body { height: auto; padding: 10px 0; }
            .container { flex-direction: column; height: auto; max-height: none; width: 95%; }
            .video-section { border-right: none; border-bottom: 1px solid #EAECEF; padding: 20px; }
            .info-section { padding: 20px; }
            #programTitle { font-size: 1.5em; }
            .controls button { width: 45px; height: 45px; font-size: 1.3em; }
            #recordBtn { width: 55px; height: 55px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-section">
            <div id="countdown"></div>
            <div class="header-info">
                <h1 id="programTitle">모의 면접 프로그램</h1>
                <p id="usageGuide">답변 종료 후 '답변 복사' 버튼을 누르고, 'AI 기반 피드백 받기'를 눌러 챗봇에게 질문하세요.</p>
            </div>
            <div class="video-container">
                <video id="webcam" autoplay playsinline muted></video>
                <p id="timer">00:00</p>
            </div>
            <div class="controls">
                <div class="control-item"><button id="flipBtn" title="좌우 반전">🔄</button><span>반전</span></div>
                <div class="control-item"><button id="pauseBtn" title="일시 정지" disabled>⏸️</button><span>정지</span></div>
                <div class="control-item"><button id="recordBtn" title="녹화 시작">녹화</button></div>
                <div class="control-item"><button id="saveBtn" title="영상 저장" disabled>💾</button><span>저장</span></div>
            </div>
        </div>
        <div class="info-section">
            <div class="input-group"><h3>1. 정보 입력</h3>
                <input type="text" id="studentSchool" placeholder="고등학교 이름을 입력하세요. (예: OO고)" style="margin-bottom: 10px;">
                <input type="text" id="studentNickname" placeholder="고유한 닉네임을 입력하세요." style="margin-bottom: 10px;">
                <select id="studentGender">
                    <option value="">성별을 선택하세요.</option>
                    <option value="남">남성</option>
                    <option value="여">여성</option>
                </select>
            </div>
            <div class="input-group">
                <h3>2. 지원 대학교 및 학과</h3>
                <input type="text" id="university" placeholder="예) OO대학교" style="margin-bottom: 10px;">
                <input type="text" id="department" placeholder="예) 인공지능학과">
                <button id="searchQuestionsBtn" style="width: 100%; padding: 10px; margin-top: 10px; background-color: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em;">
                    🔎 대학교 선행학습 영향평가 확인하기
                </button>
                <div class="search-guide">
                    <strong>[이용 안내]</strong><br>
                    1. 위에 지원 대학명 입력 후 버튼을 클릭하세요.<br>
                    2. '어디가' 사이트에서 다시 대학명을 검색하고 클릭하세요.<br>
                    3. '선행학습 영향평가' 탭에서 보고서를 다운받으세요.
                </div>
            </div>
            <div class="input-group">
                <h3>3. 면접 질문</h3>
                <select id="questionSelect">
                    <option value="자기소개 및 지원동기">가. 자기소개 및 지원동기</option>
                    <option value="자신의 성격의 장점과 단점">나. 자신의 성격의 장점과 단점</option>
                    <option value="지원 학과 관련 가장 기억에 남는 활동">다. 지원 학과 관련 가장 기억에 남는 활동</option>
                    <option value="입학 후 구체적인 학업 계획">라. 입학 후 구체적인 학업 계획</option>
                    <option value="마지막으로 하고 싶은 말">마. 마지막으로 하고 싶은 말</option>
                    <option value="custom">바. (직접 입력)</option>
                </select>
                <input type="text" id="customQuestion" placeholder="면접 질문을 직접 입력하세요." style="display: none;">
            </div>
            <div class="output-group">
                <h3 style="display: flex; align-items: center;">4. 학생 답변 내용 <button id="copyBtn">📋 답변 복사</button></h3>
                <div id="transcriptBox" class="output-box">답변을 녹화하면 음성인식 결과가 여기에 표시됩니다...</div>
            </div>
            <div class="output-group">
                <h3>5. AI 피드백 받기</h3>
                <div class="output-box feedback-guide">
                    <p>1. 위 '답변 복사' 버튼을 클릭하세요.<br>2. 아래 '피드백 받기' 버튼을 눌러 챗봇을 여세요.<br>3. 챗봇에게 복사한 내용을 붙여넣고 질문하세요.</p>
                    <a href="https://chatgpt.com/g/g-68ce2135468c8191b14ed64164d81d30-ai-giban-moyi-myeonjeob-peurogeuraem" target="_blank">🤖 AI 기반 피드백 받기</a>
                </div>
            </div>
        </div>
    </div>
<script>
    // --- 1. DOM 요소 가져오기 ---
    const webcamVideo = document.getElementById("webcam");
    const flipBtn = document.getElementById("flipBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const recordBtn = document.getElementById("recordBtn");
    const saveBtn = document.getElementById("saveBtn");
    const timerDisplay = document.getElementById("timer");
    const questionSelect = document.getElementById("questionSelect");
    const customQuestionInput = document.getElementById("customQuestion");
    const countdownDisplay = document.getElementById("countdown");
    const transcriptBox = document.getElementById("transcriptBox");
    const copyBtn = document.getElementById("copyBtn");
    const searchQuestionsBtn = document.getElementById('searchQuestionsBtn');
    
    // --- 2. 상태 변수 및 객체 초기화 ---
    let stream;
    let mediaRecorder;
    let recordedChunks = [];
    let isFlipped = false;
    let isPaused = false;
    let timerInterval = null;
    let seconds = 0;
    let fullTranscript = "";
    let isRecording = false; // <<< [추가] 녹화 상태를 명확히 추적하는 변수

    // --- ▼▼▼▼▼ [핵심 수정] 음성 인식 API 설정 (안정성 강화 버전) ▼▼▼▼▼ ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.interimResults = true; // 중간 결과는 계속 받아옴
        recognition.lang = "ko-KR";
        recognition.continuous = false; // '짧게' 인식하고 자동 종료되도록 변경

        // 음성 인식 결과가 있을 때
        recognition.onresult = (event) => {
            let interimTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    fullTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            transcriptBox.innerHTML = fullTranscript + '<i style="color:#999;">' + interimTranscript + "</i>";
        };

        // 음성 인식이 '종료될 때마다' 호출되는 이벤트
        recognition.onend = () => {
            // isRecording 플래그를 확인하여, 사용자가 '종료' 버튼을 누른게 아니라면
            // 인식을 즉시 다시 시작해서 계속 이어가는 효과를 냄
            if (isRecording && !isPaused) {
                recognition.start();
            }
        };
        
        recognition.onerror = (event) => {
            // 오류가 발생해도 onend가 호출되므로, 여기서는 콘솔에 로그만 남김
            console.error("Speech recognition error:", event);
        };

    } else {
        transcriptBox.textContent = "현재 브라우저에서는 음성 인식을 지원하지 않습니다.";
    }
    // --- ▲▲▲▲▲ 여기까지 핵심 수정 ▲▲▲▲▲ ---


    // --- 3. 핵심 기능 함수 ---
    async function setupWebcam() {
        try {
            const constraints = { 
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }, 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true
                } 
            };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            webcamVideo.srcObject = stream;
        } catch (err) {
            let message = "카메라와 마이크에 접근할 수 없습니다.\n";
            if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                message += "브라우저 설정에서 카메라와 마이크 권한을 허용해주세요.";
            } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                message += "연결된 카메라나 마이크 장치가 없습니다.";
            } else {
                message += `오류가 발생했습니다: ${err.name}.`;
            }
            alert(message);
            console.error("Error accessing media devices.", err);
        }
    }

    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            seconds++;
            timerDisplay.textContent = formatTime(seconds);
        }, 1000);
    }
    
    function stopTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    async function sendDataToServer() {
        const webAppUrl = "https://script.google.com/macros/s/AKfycbwq_4sO5v0hxlvnoRN82cUpkOcE7XjrpoBaVUbTvdB1G9fuQufDw0jcym0gwBlKF0vw/exec";
        const schoolValue = document.getElementById("studentSchool").value.trim();
        const nicknameValue = document.getElementById("studentNickname").value.trim();
        const genderValue = document.getElementById("studentGender").value;
        let questionValue = questionSelect.options[questionSelect.selectedIndex].text;
        if (questionSelect.value === 'custom') {
            questionValue = customQuestionInput.value || "직접 입력 (내용 없음)";
        }
        const formData = new FormData();
        formData.append('school', schoolValue);
        formData.append('nickname', nicknameValue);
        formData.append('gender', genderValue);
        formData.append('question', questionValue);
        formData.append('transcript', fullTranscript.trim() || "답변 내용 없음");
        try {
            await fetch(webAppUrl, { method: 'POST', body: formData });
        } catch (error) {
            console.error('데이터 전송 실패:', error);
            alert('답변 제출에 실패했습니다. 인터넷 연결을 확인 후 다시 시도해주세요.');
        }
    }

    // --- 4. 이벤트 리스너 연결 ---
    flipBtn.addEventListener("click", () => {
        isFlipped = !isFlipped;
        webcamVideo.style.transform = isFlipped ? "scaleX(1)" : "scaleX(-1)";
    });

    pauseBtn.addEventListener("click", () => {
        if (!mediaRecorder) return;
        isPaused = !isPaused; // isPaused 상태 먼저 변경
        if (isPaused) {
            mediaRecorder.pause();
            stopTimer();
            pauseBtn.innerHTML = "▶️";
            pauseBtn.title = "녹화 재개";
            if (recognition) recognition.stop(); // 일시정지 시 인식 중단
        } else {
            mediaRecorder.resume();
            startTimer();
            pauseBtn.innerHTML = "⏸️";
            pauseBtn.title = "일시 정지";
            if (recognition) recognition.start(); // 재개 시 인식 다시 시작
        }
    });

    recordBtn.addEventListener("click", () => {
        if (isRecording) {
            // 녹화 종료 로직
            isRecording = false; // <<< [수정] 상태 플래그 먼저 변경
            mediaRecorder.stop();
            if (recognition) recognition.stop();
        } else {
            // 녹화 시작 전 정보 확인
            const schoolValue = document.getElementById("studentSchool").value.trim();
            const nicknameValue = document.getElementById("studentNickname").value.trim();
            const genderValue = document.getElementById("studentGender").value;
            if (!schoolValue || !nicknameValue || !genderValue) {
                alert("1번 정보 입력의 고등학교, 닉네임, 성별을 모두 입력(선택)해주세요.");
                return;
            }

            // 카운트다운 후 녹화 시작
            let countdown = 3;
            countdownDisplay.style.display = "block";
            countdownDisplay.textContent = countdown;
            recordBtn.disabled = true;

            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownDisplay.textContent = countdown;
                } else {
                    clearInterval(countdownInterval);
                    countdownDisplay.style.display = "none";
                    recordBtn.disabled = false;
                    startRecording(); // 실제 녹화 시작 함수 호출
                }
            }, 1000);
        }
    });

    function startRecording() {
        isRecording = true; // <<< [수정] 녹화 시작 시 상태 플래그 true
        isPaused = false;
        recordedChunks = [];
        fullTranscript = "";
        transcriptBox.innerHTML = "음성 인식이 여기에 표시됩니다...";
        
        const options = { mimeType: 'video/webm; codecs=vp8, opus' };
        try {
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                delete options.mimeType;
            }
            mediaRecorder = new MediaRecorder(stream, options);
        } catch (e) {
            alert("녹화 시작에 실패했습니다. 브라우저가 녹화 기능을 지원하지 않을 수 있습니다.");
            isRecording = false;
            return;
        }

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) recordedChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            sendDataToServer();
            
            // UI 상태 업데이트
            recordBtn.innerHTML = "녹화";
            recordBtn.title = "녹화 시작";
            recordBtn.classList.remove("recording");
            saveBtn.disabled = false;
            pauseBtn.disabled = true;
            pauseBtn.innerHTML = "⏸️";
            stopTimer();
        };

        mediaRecorder.start();
        if (recognition) recognition.start();
        
        // UI 상태 업데이트
        recordBtn.innerHTML = "종료";
        recordBtn.title = "녹화 종료";
        recordBtn.classList.add("recording");
        saveBtn.disabled = true;
        pauseBtn.disabled = false;
        seconds = 0;
        timerDisplay.textContent = "00:00";
        startTimer();
    }
    
    // 이하 saveBtn, questionSelect, copyBtn, searchQuestionsBtn, window.load 이벤트 리스너는 기존과 동일
    saveBtn.addEventListener("click", () => {
        if (recordedChunks.length === 0) {
            alert("저장할 영상 데이터가 없습니다.");
            return;
        }
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const department = document.getElementById("department").value || "면접연습";
        const date = new Date().toISOString().slice(0, 10);
        let questionText = questionSelect.options[questionSelect.selectedIndex].text.substring(3);
        if (questionSelect.value === 'custom') {
            questionText = customQuestionInput.value.replace(/[^a-zA-Z0-9가-힣]/g, '').substring(0, 10) || "직접입력";
        }
        a.download = `${date}_${department}_${questionText}.webm`;
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("영상 다운로드가 시작됩니다!");
        saveBtn.disabled = true;
    });
    questionSelect.addEventListener("change", () => {
        customQuestionInput.style.display = questionSelect.value === "custom" ? "block" : "none";
    });
    copyBtn.addEventListener('click', () => {
        if (!fullTranscript.trim()) {
            alert('복사할 답변 내용이 없습니다.');
            return;
        }
        let currentQuestion = questionSelect.options[questionSelect.selectedIndex].text;
        if (questionSelect.value === "custom") {
            currentQuestion = customQuestionInput.value || "(직접 입력한 질문)";
        }
        const textToCopy = `[면접 질문]\n${currentQuestion}\n\n[학생 답변]\n${fullTranscript.trim()}`;
        navigator.clipboard.writeText(textToCopy).then(() => {
            copyBtn.textContent = '✅ 복사 완료!';
            setTimeout(() => { copyBtn.textContent = '📋 답변 복사'; }, 2000);
        }).catch(err => {
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyBtn.textContent = '✅ 복사 완료!';
                setTimeout(() => { copyBtn.textContent = '📋 답변 복사'; }, 2000);
            } catch (e) {
                alert('답변을 복사하는 데 실패했습니다.');
            }
            document.body.removeChild(textArea);
        });
    });
    searchQuestionsBtn.addEventListener('click', () => {
        const universityName = document.getElementById('university').value.trim();
        if (!universityName) {
            alert('먼저 대학교 이름을 입력해주세요.');
            return;
        }
        const adigaUrl = 'https://www.adiga.kr/ucp/uvt/uni/univView.do?menuId=PCUVTINF2000';
        window.open(adigaUrl, '_blank');
    });
    window.addEventListener("load", () => {
        const participationCode = "interview2025";
        const urlParams = new URLSearchParams(window.location.search);
        const codeFromUrl = urlParams.get('code');
        const enteredCode = codeFromUrl || prompt("프로그램 참여 코드를 입력하세요:", "");
        if (enteredCode === participationCode) {
            setupWebcam();
        } else {
            if (codeFromUrl) {
                alert("URL에 포함된 참여 코드가 올바르지 않습니다.");
            } else {
                alert("참여 코드가 올바르지 않습니다. 사전 설문 완료 후 받은 코드를 확인해주세요.");
            }
            document.body.innerHTML = "<h1>접근 권한이 없습니다.</h1><p>사전 설문조사를 먼저 완료해주세요.</p>";
        }
    });
</script>
</body>
</html>
